<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scavenger Scrabble: Side-by-Side Bingo</title>
    <style>
        :root { --cell-size: 42px; --p1-color: #3b82f6; --p2-color: #ef4444; }
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; background: #fdfcf0; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; overflow-x: hidden;}

        /* SELECTION SCREEN */
        #selection-screen { position: fixed; top:0; left:0; width: 100%; height: 100%; background: #fdfcf0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 120px); gap: 20px; margin-top: 20px; }
        .avatar-choice { font-size: 60px; background: white; border: 4px solid #cbd5e1; border-radius: 20px; cursor: pointer; transition: 0.2s; padding: 10px; text-align: center; }
        .avatar-choice:hover { transform: scale(1.1); border-color: #94a3b8; }

        /* GAME LAYOUT */
        #game-page { display: none; flex-direction: column; align-items: center; width: 100%; }
        .game-header { text-align: center; margin-bottom: 15px; padding: 15px; border-radius: 20px; width: 60%; color: white; display: flex; align-items: center; justify-content: center; gap: 20px; }
        .p1-turn { background: var(--p1-color); }
        .p2-turn { background: var(--p2-color); }

        /* SIDE BY SIDE BINGO SECTION */
        .bingo-container-wrapper { display: flex; gap: 40px; margin-bottom: 20px; justify-content: center; width: 100%; }
        .bingo-zone { text-align: center; padding: 10px; border-radius: 20px; background: #f1f5f9; border: 3px solid #cbd5e1; }
        .bingo-grid { display: grid; grid-template-columns: repeat(3, 70px); gap: 8px; background: #cbd5e1; padding: 10px; border-radius: 12px; }
        .bingo-cell { width: 70px; height: 70px; background: white; font-size: 35px; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
        .marked { background: #69f0ae !important; box-shadow: 0 0 15px #69f0ae; border: 3px solid #2e7d32 !important; }

        /* MAIN GAME AREA */
        .main-game-area { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
        .current-avatar-display { font-size: 90px; background: white; padding: 15px; border-radius: 25px; border: 5px solid #cbd5e1; box-shadow: 0 8px 0 #cbd5e1; }
        
        .board { display: grid; grid-template-columns: repeat(13, var(--cell-size)); grid-template-rows: repeat(13, var(--cell-size)); gap: 2px; background: #5d4037; padding: 8px; border: 6px solid #3e2723; border-radius: 12px; }
        .board-cell { width: var(--cell-size); height: var(--cell-size); background: #fffde7; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; position: relative; font-size: 1.3rem; }
        .board-cell.start-square { background-color: #ff5252 !important; border: 2px solid #b71c1c !important; }
        .icon-square::after { content: attr(data-icon); position: absolute; font-size: 18px; bottom: 1px; right: 1px; opacity: 0.8; }

        /* HORIZONTAL BAG SECTION */
        .horizontal-bag { width: 100%; max-width: 600px; background: white; padding: 15px; border-radius: 15px; border: 2px solid #cbd5e1; margin-top: 15px; }
        .bag-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; font-size: 0.9rem; }
        .bag-item { background: #f8fafc; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; }

        /* RACK & BUTTONS */
        .rack-container { margin: 25px; padding: 20px; background: #efebe9; border-radius: 25px; width: 650px; text-align: center; border: 4px dashed #a1887f; }
        .tile { display: inline-block; width: 50px; height: 60px; background: #ffe082; border: 3px solid #ff8f00; border-radius: 10px; line-height: 60px; font-size: 34px; font-weight: bold; margin: 5px; cursor: pointer; box-shadow: 0 5px 0 #ff8f00; }
        .tile.selected { background: #ffca28; transform: translateY(-10px); }
        .tile.blank-tile { background: #81c784 !important; border-color: #2e7d32 !important; color: white; box-shadow: 0 5px 0 #2e7d32; }

        .btn-group { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        button { padding: 15px 25px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; color: white; font-size: 1.1rem; }
        .btn-finish { background: #4caf50; }
        .btn-recall { background: #78909c; }
        .btn-pass { background: #ff9800; }
        
        #win-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 300; }
        .hidden-visibility { opacity: 0.2; filter: grayscale(1); } /* Gray out the card not in turn */
    </style>
</head>
<body>

    <div id="selection-screen">
        <h1 id="selection-title">Player 1: Pick your Animal!</h1>
        <div class="avatar-grid" id="avatar-grid">
            <div class="avatar-choice" onclick="selectAvatar('üêº')">üêº</div>
            <div class="avatar-choice" onclick="selectAvatar('üêØ')">üêØ</div>
            <div class="avatar-choice" onclick="selectAvatar('ü¶Å')">ü¶Å</div>
            <div class="avatar-choice" onclick="selectAvatar('üêò')">üêò</div>
            <div class="avatar-choice" onclick="selectAvatar('üê∞')">üê∞</div>
            <div class="avatar-choice" onclick="selectAvatar('ü¶ä')">ü¶ä</div>
            <div class="avatar-choice" onclick="selectAvatar('üê∏')">üê∏</div>
            <div class="avatar-choice" onclick="selectAvatar('üêµ')">üêµ</div>
        </div>
    </div>

    <div id="game-page">
        <div id="turn-indicator" class="game-header p1-turn">
            <span id="header-avatar" style="font-size: 40px; margin-right: 15px;"></span>
            <h2 id="turn-text" style="margin:0;">Player 1's Turn</h2>
        </div>

        <div class="bingo-container-wrapper">
            <div id="p1-bingo-zone" class="bingo-zone">
                <h4 id="p1-label">Player 1</h4>
                <div id="p1-bingo" class="bingo-grid"></div>
            </div>
            <div id="p2-bingo-zone" class="bingo-zone">
                <h4 id="p2-label">Player 2</h4>
                <div id="p2-bingo" class="bingo-grid"></div>
            </div>
        </div>

        <div class="main-game-area">
            <div id="active-avatar-sidebar" class="current-avatar-display">üêº</div>
            <div id="board" class="board"></div>
        </div>

        <div class="horizontal-bag">
            <div id="bag-display" class="bag-grid"></div>
        </div>

        <div class="rack-container">
            <div id="current-rack"></div>
            <div class="btn-group">
                <button class="btn-recall" onclick="recallTiles()">Recall</button>
                <button class="btn-pass" onclick="passTurn()">Pass Turn</button>
                <button class="btn-finish" onclick="finishTurn()">Finish Turn</button>
            </div>
        </div>
    </div>

    <div id="win-overlay">
        <h1 id="win-message" style="font-size: 4rem;"></h1>
        <button onclick="location.reload()" style="background:#4caf50; padding: 20px 40px; font-size: 1.5rem;">Play Again</button>
    </div>

<script>
    const icons = ['üçé', 'üöÄ', 'ü¶Å', 'üçï', 'üíé', 'üåà', 'üé∏', 'üç¶', 'üéà'];
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const vowels = "AEIOU";
    const tileDistribution = {'E': 12, 'A': 9, 'I': 9, 'O': 8, 'N': 6, 'R': 6, 'T': 6, 'D': 4, 'L': 4, 'S': 4, 'U': 4, 'G': 3, 'B': 2, 'C': 2, 'M': 2, 'P': 2, 'F': 2, 'H': 2, 'V': 2, 'W': 2, 'Y': 2, '?': 2, 'K': 1, 'J': 1, 'X': 1, 'Q': 1, 'Z': 1};

    let p1Avatar = '', p2Avatar = '';
    let tileBag = [], currentPlayer = 1, selectedTileIndex = null, iconMap = {}, gameActive = true, newTilesThisTurn = [];
    let boardIsFresh = true, gameState = { p1: { rack: [], bingo: [] }, p2: { rack: [], bingo: [] } };

    function selectAvatar(emoji) {
        if (!p1Avatar) {
            p1Avatar = emoji;
            document.getElementById('selection-title').innerText = "Player 2: Pick your Animal!";
            event.target.style.opacity = "0.2";
        } else {
            p2Avatar = emoji;
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('game-page').style.display = 'flex';
            init();
        }
    }

    function init() {
        for (let l in tileDistribution) { for (let i = 0; i < tileDistribution[l]; i++) tileBag.push(l); }
        shuffle(tileBag);
        generateIconMap();
        createBoard();
        for(let p of ['p1', 'p2']) {
            gameState[p].rack = drawBalanced(7);
            gameState[p].bingo = Array.from({length: 9}, () => icons[Math.floor(Math.random()*9)]);
        }
        document.getElementById('p1-label').innerText = p1Avatar + " Card";
        document.getElementById('p2-label').innerText = p2Avatar + " Card";
        updateUI();
        renderBingo(1); renderBingo(2);
    }

    function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } }

    function drawBalanced(count, existing = []) {
        let hand = [...existing];
        while(hand.length < count && tileBag.length > 0) hand.push(tileBag.pop());
        let vCount = hand.filter(l => vowels.includes(l)).length;
        if(vCount < 2 && hand.length >= 2) {
            for(let i=0; i < hand.length && vCount < 2; i++) {
                if(!vowels.includes(hand[i]) && hand[i] !== '?') {
                    let vIdx = tileBag.findIndex(l => vowels.includes(l));
                    if(vIdx !== -1) {
                        let old = hand[i]; hand[i] = tileBag.splice(vIdx, 1)[0]; tileBag.push(old); shuffle(tileBag); vCount++;
                    }
                }
            }
        }
        return hand;
    }

    function generateIconMap() {
        let spots = new Set();
        while(spots.size < 50) { 
            let s = Math.floor(Math.random() * 169);
            if(s !== 84) spots.add(s);
        }
        spots.forEach(s => iconMap[`${Math.floor(s/13)}-${s%13}`] = icons[Math.floor(Math.random()*9)]);
    }

    function createBoard() {
        const board = document.getElementById('board');
        for(let r=0; r<13; r++) {
            for(let c=0; c<13; c++) {
                const cell = document.createElement('div');
                cell.className = 'board-cell';
                if(r === 6 && c === 6) cell.classList.add('start-square');
                if(iconMap[`${r}-${c}`]) { cell.classList.add('icon-square'); cell.setAttribute('data-icon', iconMap[`${r}-${c}`]); }
                cell.onclick = () => placeTile(r, c);
                cell.id = `cell-${r}-${c}`;
                board.appendChild(cell);
            }
        }
    }

    function updateUI() {
        const currentAvatar = currentPlayer === 1 ? p1Avatar : p2Avatar;
        document.getElementById('active-avatar-sidebar').innerText = currentAvatar;
        document.getElementById('header-avatar').innerText = currentAvatar;
        document.getElementById('turn-text').innerText = `Player ${currentPlayer}'s Turn`;
        document.getElementById('turn-indicator').className = `game-header p${currentPlayer}-turn`;
        
        // Gray out non-active Bingo card
        document.getElementById('p1-bingo-zone').className = currentPlayer === 1 ? 'bingo-zone' : 'bingo-zone hidden-visibility';
        document.getElementById('p2-bingo-zone').className = currentPlayer === 2 ? 'bingo-zone' : 'bingo-zone hidden-visibility';

        const d = document.getElementById('bag-display');
        const counts = {}; tileBag.forEach(l => counts[l] = (counts[l] || 0) + 1);
        d.innerHTML = '';
        Object.keys(tileDistribution).sort().forEach(l => {
            let item = document.createElement('div');
            item.className = 'bag-item';
            item.innerHTML = `${l === '?' ? '‚ôªÔ∏è' : l}:${counts[l] || 0}`;
            d.appendChild(item);
        });
        renderRack();
    }

    function renderRack() {
        const rD = document.getElementById('current-rack'); rD.innerHTML = '';
        gameState[`p${currentPlayer}`].rack.forEach((l, i) => {
            const t = document.createElement('div');
            t.className = 'tile' + (selectedTileIndex === i ? ' selected' : '');
            if (l === '?') { t.classList.add('blank-tile'); t.innerText = ""; } else { t.innerText = l; }
            t.onclick = () => { if(gameActive) { selectedTileIndex = i; renderRack(); } };
            rD.appendChild(t);
        });
    }

    function placeTile(r, c) {
        if(!gameActive) return;
        const cell = document.getElementById(`cell-${r}-${c}`);
        if (selectedTileIndex !== null && cell.innerText === "") {
            let letter = gameState[`p${currentPlayer}`].rack[selectedTileIndex];
            if(letter === '?') {
                let ch = prompt("What letter?").toUpperCase();
                if(ch && ch.length === 1 && /[A-Z]/.test(ch)) letter = ch; else return;
                cell.style.backgroundColor = "#dcfce7";
            }
            cell.innerText = letter; cell.style.color = "#2563eb"; 
            newTilesThisTurn.push({r, c, letter, wasBlank: (gameState[`p${currentPlayer}`].rack[selectedTileIndex] === '?')});
            gameState[`p${currentPlayer}`].rack.splice(selectedTileIndex, 1);
            selectedTileIndex = null; renderRack();
        }
    }

    function recallTiles() {
        newTilesThisTurn.forEach(t => {
            const cell = document.getElementById(`cell-${t.r}-${t.c}`);
            cell.innerText = ""; cell.style.color = ""; cell.style.backgroundColor = "";
            gameState[`p${currentPlayer}`].rack.push(t.wasBlank ? '?' : t.letter);
        });
        newTilesThisTurn = []; selectedTileIndex = null; renderRack();
    }

    function passTurn() {
        if(confirm("Pass? Get new letters.")) {
            recallTiles(); tileBag.push(...gameState[`p${currentPlayer}`].rack); shuffle(tileBag);
            gameState[`p${currentPlayer}`].rack = drawBalanced(7); switchTurn();
        }
    }

    async function finishTurn() {
        if(newTilesThisTurn.length === 0) return;
        let isC = boardIsFresh ? newTilesThisTurn.some(t => t.r === 6 && t.c === 6) : 
            newTilesThisTurn.some(t => {
                return [[-1,0],[1,0],[0,-1],[0,1]].some(([dr, dc]) => {
                    let n = document.getElementById(`cell-${t.r+dr}-${t.c+dc}`);
                    return n && n.innerText !== "" && n.style.color === "rgb(0, 0, 0)";
                });
            });
        if(!isC) { alert("Connect your word!"); return; }
        const word = scanForWord();
        if(!word) { alert("Straight line!"); return; }
        if (await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`).then(r => r.ok)) {
            newTilesThisTurn.forEach(t => {
                if(iconMap[`${t.r}-${t.c}`]) markBingoCard(iconMap[`${t.r}-${t.c}`]);
                document.getElementById(`cell-${t.r}-${t.c}`).style.color = "rgb(0, 0, 0)";
            });
            newTilesThisTurn = []; boardIsFresh = false;
            gameState[`p${currentPlayer}`].rack = drawBalanced(7, gameState[`p${currentPlayer}`].rack);
            switchTurn();
        } else alert("Not a word!");
    }

    function scanForWord() {
        const rows = newTilesThisTurn.map(t => t.r), cols = newTilesThisTurn.map(t => t.c);
        const isH = rows.every(r => r === rows[0]), isV = cols.every(c => c === cols[0]);
        if (!isH && !isV) return null;
        let word = "";
        let r = rows[0], c = cols[0];
        if (isH) {
            let minC = Math.min(...cols), maxC = Math.max(...cols);
            while(minC > 0 && document.getElementById(`cell-${r}-${minC-1}`).innerText !== "") minC--;
            while(maxC < 12 && document.getElementById(`cell-${r}-${maxC+1}`).innerText !== "") maxC++;
            for(let i = minC; i <= maxC; i++) word += document.getElementById(`cell-${r}-${i}`).innerText;
        } else {
            let minR = Math.min(...rows), maxR = Math.max(...rows);
            while(minR > 0 && document.getElementById(`cell-${minR-1}-${c}`).innerText !== "") minR--;
            while(maxR < 12 && document.getElementById(`cell-${maxR+1}-${c}`).innerText !== "") maxR++;
            for(let i = minR; i <= maxR; i++) word += document.getElementById(`cell-${i}-${c}`).innerText;
        }
        return word;
    }

    function markBingoCard(icon) {
        gameState[`p${currentPlayer}`].bingo.forEach((item, i) => {
            if(item === icon) document.getElementById(`p${currentPlayer}-bingo-${i}`).classList.add('marked');
        });
        checkBingoWin();
    }

    function checkBingoWin() {
        const g = Array.from({length: 9}, (_, i) => document.getElementById(`p${currentPlayer}-bingo-${i}`).classList.contains('marked'));
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        if(wins.some(w => w.every(i => g[i]))) {
            gameActive = false;
            document.getElementById('win-message').innerText = `${currentPlayer === 1 ? p1Avatar : p2Avatar} BINGO WINS!`;
            document.getElementById('win-overlay').style.display='flex';
        }
    }

    function renderBingo(p) {
        const g = document.getElementById(`p${p}-bingo`); g.innerHTML = '';
        gameState[`p${p}`].bingo.forEach((icon, i) => {
            const c = document.createElement('div'); c.className = 'bingo-cell'; c.id = `p${p}-bingo-${i}`; c.innerText = icon; g.appendChild(c);
        });
    }

    function switchTurn() {
        currentPlayer = currentPlayer === 1 ? 2 : 1;
        updateUI();
    }
</script>
</body>
</html>
